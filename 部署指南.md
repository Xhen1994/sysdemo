# 协同数字化平台 - 服务器部署指南

## 一、服务器信息

- **服务器IP**: 14.103.165.46
- **访问端口**: 4000
- **项目路径**: /home/xhen/myprojects/sysdemo
- **Conda环境**: sysdemo (Python 3.11)
- **Conda路径**: /home/xhen/miniconda3/envs/sysdemo

## 二、部署步骤

### 1. 连接服务器

```bash
ssh xhen@14.103.165.46
```

### 2. 进入项目目录

```bash
cd /home/xhen/myprojects/sysdemo
```

### 3. 创建并激活Conda环境

```bash
# 创建环境
conda create -n sysdemo python=3.11 -y

# 激活环境
conda activate sysdemo
```

### 4. 安装依赖

```bash
pip install -r requirements.txt
```

### 5. 配置环境变量（可选）

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑环境变量
nano .env

# 设置以下变量（根据需要）:
# SECRET_KEY=your-production-secret-key
# DEEPSEEK_API_KEY=your-deepseek-api-key
```

### 6. 创建必要的目录

```bash
mkdir -p data
mkdir -p data/uploads
mkdir -p logs
```

### 7. 设置脚本执行权限

```bash
chmod +x start.sh
chmod +x stop.sh
chmod +x restart.sh
```

### 8. 启动应用

```bash
./start.sh
```

应用将在后台运行，访问地址：http://14.103.165.46:4000

### 9. 检查应用状态

```bash
# 查看应用进程
ps aux | grep "python app.py"

# 查看应用日志
tail -f logs/app.log
```

## 三、常用操作

### 停止应用

```bash
./stop.sh
```

### 重启应用

```bash
./restart.sh
```

### 查看日志

```bash
# 实时查看日志
tail -f logs/app.log

# 查看最近100行日志
tail -n 100 logs/app.log

# 搜索错误日志
grep -i error logs/app.log
```

### 备份数据

```bash
# 创建备份
tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz data/

# 将备份移动到安全位置
mv backup-*.tar.gz ~/backups/
```

### 恢复数据

```bash
# 解压备份
tar -xzf backup-YYYYMMDD-HHMMSS.tar.gz

# 如果需要，删除现有数据并恢复
rm -rf data/
tar -xzf backup-YYYYMMDD-HHMMSS.tar.gz
```

## 四、配置防火墙

### 开放4000端口

```bash
# 如果使用firewalld
sudo firewall-cmd --permanent --add-port=4000/tcp
sudo firewall-cmd --reload

# 如果使用ufw
sudo ufw allow 4000/tcp
sudo ufw reload

# 如果使用iptables
sudo iptables -A INPUT -p tcp --dport 4000 -j ACCEPT
sudo iptables-save
```

## 五、设置开机自启动

### 方法1：使用systemd（推荐）

1. 创建服务文件：

```bash
sudo nano /etc/systemd/system/sysdemo.service
```

2. 添加以下内容：

```ini
[Unit]
Description=Provincial Collaborative Digital Platform
After=network.target

[Service]
Type=simple
User=xhen
WorkingDirectory=/home/xhen/myprojects/sysdemo
Environment="PATH=/home/xhen/miniconda3/envs/sysdemo/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/xhen/miniconda3/envs/sysdemo/bin/python /home/xhen/myprojects/sysdemo/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

3. 启用并启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable sysdemo
sudo systemctl start sysdemo

# 查看服务状态
sudo systemctl status sysdemo

# 查看服务日志
sudo journalctl -u sysdemo -f
```

### 方法2：使用crontab

```bash
# 编辑crontab
crontab -e

# 添加以下行（在系统重启后启动）
@reboot cd /home/xhen/myprojects/sysdemo && ./start.sh
```

## 六、性能优化

### 1. 使用Gunicorn（生产环境推荐）

安装Gunicorn：

```bash
pip install gunicorn
```

修改 `start.sh`：

```bash
# 替换最后的启动命令为：
nohup gunicorn -w 4 -b 0.0.0.0:4000 app:app > logs/app.log 2>&1 &
```

### 2. 使用Nginx反向代理

安装Nginx：

```bash
sudo apt install nginx  # Ubuntu/Debian
# 或
sudo yum install nginx  # CentOS/RHEL
```

配置Nginx：

```bash
sudo nano /etc/nginx/sites-available/sysdemo
```

添加配置：

```nginx
server {
    listen 80;
    server_name 14.103.165.46;

    location / {
        proxy_pass http://127.0.0.1:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static {
        alias /home/xhen/myprojects/sysdemo/static;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/sysdemo /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 七、监控和维护

### 1. 日志轮转

创建日志轮转配置：

```bash
sudo nano /etc/logrotate.d/sysdemo
```

添加内容：

```
/home/xhen/myprojects/sysdemo/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 xhen xhen
}
```

### 2. 定期备份

创建备份脚本：

```bash
nano ~/backup-sysdemo.sh
```

添加内容：

```bash
#!/bin/bash
BACKUP_DIR=~/backups/sysdemo
mkdir -p $BACKUP_DIR
cd /home/xhen/myprojects/sysdemo
tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz data/
# 删除30天前的备份
find $BACKUP_DIR -name "backup-*.tar.gz" -mtime +30 -delete
```

设置定时任务：

```bash
chmod +x ~/backup-sysdemo.sh
crontab -e

# 添加：每天凌晨2点备份
0 2 * * * ~/backup-sysdemo.sh
```

### 3. 监控脚本

创建监控脚本：

```bash
nano ~/monitor-sysdemo.sh
```

添加内容：

```bash
#!/bin/bash
if ! pgrep -f "python app.py" > /dev/null; then
    echo "$(date): Application is down, restarting..." >> ~/sysdemo-monitor.log
    cd /home/xhen/myprojects/sysdemo
    ./start.sh
fi
```

设置定时检查：

```bash
chmod +x ~/monitor-sysdemo.sh
crontab -e

# 添加：每5分钟检查一次
*/5 * * * * ~/monitor-sysdemo.sh
```

## 八、故障排查

### 问题1：应用无法启动

**排查步骤**:

1. 检查端口占用：
```bash
netstat -tuln | grep 4000
lsof -i :4000
```

2. 查看日志：
```bash
tail -f logs/app.log
```

3. 检查Python环境：
```bash
conda activate sysdemo
python --version
which python
```

### 问题2：无法访问

**排查步骤**:

1. 检查应用是否运行：
```bash
ps aux | grep "python app.py"
```

2. 检查防火墙：
```bash
sudo firewall-cmd --list-all  # firewalld
sudo ufw status               # ufw
sudo iptables -L -n           # iptables
```

3. 测试本地连接：
```bash
curl http://localhost:4000
```

### 问题3：数据丢失

**解决方法**:

1. 从备份恢复：
```bash
cd /home/xhen/myprojects/sysdemo
tar -xzf ~/backups/sysdemo/backup-YYYYMMDD-HHMMSS.tar.gz
```

2. 重启应用：
```bash
./restart.sh
```

## 九、安全建议

1. **修改默认密码**: 首次登录后立即修改admin密码
2. **限制IP访问**: 在防火墙中限制访问来源
3. **使用HTTPS**: 配置SSL证书（推荐使用Let's Encrypt）
4. **定期更新**: 定期更新Python依赖包
5. **备份加密**: 对备份文件进行加密存储
6. **审计日志**: 定期检查系统日志

## 十、更新部署

### 从Git仓库更新

```bash
cd /home/xhen/myprojects/sysdemo
git pull
pip install -r requirements.txt
./restart.sh
```

### 手动更新

1. 上传新文件到服务器
2. 备份现有数据
3. 替换应用文件
4. 重启应用

## 十一、联系信息

如有问题，请联系系统管理员。

---

**最后更新**: 2025年10月

