{% extends "base.html" %}

{% block title %}问题反馈 - 协同数字化平台{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-exclamation-circle"></i> 问题反馈</h2>
    <div>
        {% if current_user.role in ['admin', 'province_manager'] %}
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#aiSummaryModal">
            <i class="bi bi-stars"></i> AI总结
        </button>
        {% endif %}
        <a href="{{ url_for('issues.create') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 提交问题
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if issues %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>标题</th>
                        <th>类别</th>
                        <th>优先级</th>
                        <th>状态</th>
                        <th>提交时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for issue in issues %}
                    <tr>
                        <td><strong>{{ issue.title }}</strong></td>
                        <td>
                            {% if issue.category == 'bug' %}
                                <span class="badge bg-danger">缺陷</span>
                            {% elif issue.category == 'feature' %}
                                <span class="badge bg-info">新功能</span>
                            {% elif issue.category == 'improvement' %}
                                <span class="badge bg-warning">改进</span>
                            {% else %}
                                <span class="badge bg-secondary">问题</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if issue.priority == 'urgent' %}
                                <span class="badge bg-danger">紧急</span>
                            {% elif issue.priority == 'high' %}
                                <span class="badge bg-warning">高</span>
                            {% elif issue.priority == 'medium' %}
                                <span class="badge bg-info">中</span>
                            {% else %}
                                <span class="badge bg-secondary">低</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if issue.status == 'open' %}
                                <span class="badge bg-secondary">待处理</span>
                            {% elif issue.status == 'assigned' %}
                                <span class="badge bg-primary">已分配</span>
                            {% elif issue.status == 'in_progress' %}
                                <span class="badge bg-info">处理中</span>
                            {% elif issue.status == 'resolved' %}
                                <span class="badge bg-success">已解决</span>
                            {% elif issue.status == 'closed' %}
                                <span class="badge bg-dark">已关闭</span>
                            {% endif %}
                        </td>
                        <td>{{ issue.created_at[:10] }}</td>
                        <td>
                            <a href="{{ url_for('issues.detail', issue_id=issue.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> 查看
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="mt-3 text-muted">暂无问题反馈</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- AI总结模态框 -->
<div class="modal fade" id="aiSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-stars"></i> AI问题总结</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="aiSummaryForm">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">省份</label>
                            <select class="form-select" name="province">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">类别</label>
                            <select class="form-select" name="category">
                                <option value="">全部</option>
                                <option value="bug">缺陷</option>
                                <option value="feature">新功能</option>
                                <option value="improvement">改进</option>
                                <option value="question">问题</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">状态</label>
                            <select class="form-select" name="status">
                                <option value="">全部</option>
                                <option value="open">待处理</option>
                                <option value="in_progress">处理中</option>
                            </select>
                        </div>
                    </div>
                    <div id="summaryResult" class="mt-3" style="display:none;">
                        <div class="alert alert-info">
                            <h6>AI分析结果：</h6>
                            <div id="summaryContent"></div>
                        </div>
                    </div>
                    <div id="summaryLoading" style="display:none;" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">AI正在分析中，请稍候...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-stars"></i> 生成总结
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('aiSummaryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    document.getElementById('summaryLoading').style.display = 'block';
    document.getElementById('summaryResult').style.display = 'none';
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("issues.ai_summary") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('summaryLoading').style.display = 'none';
        if (data.success) {
            document.getElementById('summaryContent').innerText = data.summary;
            document.getElementById('summaryResult').style.display = 'block';
        } else {
            alert('AI总结失败: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('summaryLoading').style.display = 'none';
        alert('请求失败: ' + error);
    });
});
</script>
{% endblock %}

